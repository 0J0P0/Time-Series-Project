---
title: "Exemple Profe 4"
output: pdf_document
date: "2023-03-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Lectura serie original

```{r}
ser = ts(read.table("aeronausMAD.csv"), start = 1990, freq = 12)
ser = window(ser, end=c(2019,12))
plot(ser)
```

## Serie transformada en estacioanria (tras aplicar todas las transformaciones en el debido modo)

```{r}
lnser = log(ser)
d1d12lnser = diff(diff(lnser,12))
plot(d1d12lnser)
```

No hay clusters de volatilidad, solo puntos concretos en los que la variancia no es del todo constante.

## Análisis ACF y PACF

```{r}
par(mfrow=c(1,2))
acf(d1d12lnser, ylim=c(-1,1), lag.max = 72, lwd=2, col=c(2,rep(1,11))) # en rojo los retrasos múltiples de la frecuencia para representar el componente estacional.
pacf(d1d12lnser, ylim=c(-1,1), lag.max = 72, lwd=2, col=c(rep(1,11),2)) # el pacf comienza en el 1, por tanto ahora giramos el orden de los colores
par(mfrow=c(1,1))
```

## Identificación de modelos

Debido al patrón de decrecimiento similar al exponencial de la parte estacional en el PACF, podemos empezar considerando que los retrasos finitos para el caso estacional se situan en el ACF, por lo que se trata de un MA, pudiendo ser MA(1) o MA(3) los más razonables también pudiendo considerarse MA(5) y MA(6). Es recomendable empezar con el MA(3) ya que si resulta que hay parámetros no signifcativos podremos acabar regresando al MA(1) al eliminarlos.

Para la parte regular se podría considerar cualquiera de los dos gráficos para los retrasos finitos. En el caso del AR consideraríamos un AR(2) fijandonos en el PACF, para el ACF se pueden considerar tanto MA(3) como MA(4), pero una vez más es recomendable empezar con el MA(4) ya que podremos simplificar más tarde. Para ver que MA(1) no es una buena idea, ajustaremos con MA(3) estacional y AR(2) y MA(1) regulares para ver que resultado obtenemos, siendo los midelos resultantes ARIMA(0,1,1)(0,1,3)_12 y ARIMA(2,1,0)(0,1,3)_12


```{r}
# Comenzamos ajustando el modelo para la serie estacionaria y así comprobamos si la media es un parámetro significativo. Por tanto los parametros d y D los pondremos a 0 ya que ya hemos aplicado las diferenciaciones manualmente.
m1=arima(d1d12lnser, order=c(0,0,1), seasonal = list(order=c(0,0,3), period = 12))
m1
```
```{r}
# Haciendo el t-ratio vemos que la media no es significativa, por tanto aplicaremos el modelo a la serie lnser.
m1=arima(lnser, order=c(0,1,1), seasonal = list(order=c(0,1,3), period = 12))
m1
```
```{r}
# El tercer parámetro no es signifcativo por lo que re-ajustaremos el modelo:
m1=arima(lnser, order=c(0,1,1), seasonal = list(order=c(0,1,3), period = 12), fixed=c(NA,NA,0,NA))
m1
```
Vemos que el aic ha aumentado por lo que hemos tomado una buena decisión.

## ACF de los rediduos

```{r}
acf(resid(m1), ylim=c(-1,1), lag.max = 72, lwd=2, col=c(2,rep(1,11)))
pacf(resid(m1), ylim=c(-1,1), lag.max = 72, lwd=2, col=c(rep(1,11), 2))
```

```{r}
# Test de Ljung-Box para reafirmar si algun retraso es significativo o no: si estan por debajo de la línea azul  no podemos considerar ese retraso como fruto del azar, es decir, si un p-valor está por debajo de 0.05 ese retraso ya no es compatible con ruido blanco.

tsdiag(m1, gof.lag = 72)
```

Analizando estos gráficos confirmamos la hipótesis de que un MA(1) para la parte regular no es suficiente para explicar la serie temporal. Como el tercer retraso es el primero significativo en el PACF de los residuos, es decir, necesitamos 3 retrasos para 'atraparlo' por lo que al modelo actual le sumamos 3 parámetros obteniendo un MA(4). También se podrái proponer un ARMA(3,1) si nos fijamos en el PACF de los residuos.


```{r}
# Antes habría que comprobar el ajuste sobre la serie estacionaria para confirmar que la media no es significativa.
m1=arima(lnser, order=c(0,1,4), seasonal = list(order=c(0,1,3), period = 12))
m1
```
El segundo parametro no es significativo.

```{r}
# Es recomendable retirar parámetros con t-ratios pmás pequeños antes.
m1=arima(lnser, order=c(0,1,4), seasonal = list(order=c(0,1,3), period = 12),fixed=c(NA,0,NA,NA,NA,NA,NA))
m1
```
El penúltimo parámetro sigue no siendo signifiativo así que retiramos también.

```{r}
m1=arima(lnser, order=c(0,1,4), seasonal = list(order=c(0,1,3), period = 12),fixed=c(NA,0,NA,NA,NA,0,NA))
m1
```

```{r}
acf(resid(m1), ylim=c(-1,1), lag.max = 72, lwd=2, col=c(2,rep(1,11)))
pacf(resid(m1), ylim=c(-1,1), lag.max = 72, lwd=2, col=c(rep(1,11), 2))
```

```{r}
tsdiag(m1, gof.lag = 72)
```

## Validación 

### 1) Análisi de residuos

- Variancia constante (Homocedasteicidad) - Outliers o Volatilidad -> se comprueba con plot de los residuos

- Normalidad

- Independencia (condición más importantes) : Se valida con lo que ya hemos hecho, acf y pacf de residuos y Ljung-Box

#### Variancia constante

```{r}
resi = resid(m1)
plot(resi)
abline(h = 0)
abline(h = c(-3*sd(resi), 3*sd(resi)), lty = 3,col = "blue") # este intervalo debe contener el 99% de los casos. Si hay más de un 1% fuera resulta problemático.
```

Hay que saber diferenciar entre volatilidad (hay clusters en los que los residuos tienen más amplitud que en otros periodos) y atípicos (el 1% que cae fuera del intervalo).

```{r}
scatter.smooth(sqrt(abs(resi)), lpars = list(col=2)) # la linea roja debe ser aproximadamente horizontal, teniendo en cuenta una banda de confianza para poder asumir varianza constante a excepción de los atípicos
```

#### Normalidad

```{r}
qqnorm(resi)
qqline(resi,col=2,lwd=2) 
# se considerará que hay volatilidad si hay heavy tails, si no, se considerarán atípicos 
```


```{r}
hist(resi,breaks=20, freq=FALSE); curve(dnorm(x, mean=mean(resi),
sd=sd(resi)), col=2, add=T)

```

### 2) Propiedades del modelo

- CAUSAL/ESTACIONARIA?

- INVERTIBLE?

```{r}
c(1,m1$model$theta) #considerando el termino independiente
```

