---
title: "Project"
author: "Juan Pablo Zaldivar && Enric Millan"
date: "2023-03-14"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo=FALSE) 
```

```{r}
library(car)
library(plotly)
library(webshot)
library(qqplotr)
library(forecast)
library(TSstudio)
```

# Titulo

# Introducción

## Descripción Serie Temporal

```{r}
ser <- ts(read.table("Data/export.dat")/1000,start=1999,freq=12)
```

```{r}
f1 = plot_ly(x=~time(ser), y=~ser,
        type = "scatter",
        fill="tozeroy",
        mode="lines",
        line = list(color = "#2a788e"),
        fillcolor="rgba(42, 120, 142, 0.5)"
        ) %>% 
  layout(title='<b> Total exportations in Spain <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='(Thousand million euros)')
         )

f1;
```


```{r}
ds <- decompose(ser)

p1 <- plot_ly() %>% add_trace(x = time(ds$x), y = ds$x,
                              type = "scatter",
                              mode = "lines",
                              fill="tonexty",
                              line = list(color = "rgb(34, 168, 132)"),
                              fillcolor="rgba(34, 168, 132, 0.5)",
                              name = "Original Time Series")
p2 <- plot_ly() %>% add_trace(x = time(ds$trend), y = ds$trend,
                              type = "scatter",
                              mode = "lines",
                              fill="tonexty",
                              line = list(color = "rgb(42, 120, 142)"),
                              fillcolor="rgba(42, 120, 142, 0.5)",
                              name = "Trend")
p3 <- plot_ly() %>% add_trace(x = time(ds$seasonal), y = ds$seasonal,
                              type = "scatter",
                              mode = "lines",
                              fill="tonexty",
                              line = list(color = "rgb(65, 68, 135)"),
                              fillcolor="rgba(65, 68, 135, 0.5)",
                              name = "Seasonal")
p4 <- plot_ly() %>% add_trace(x = time(ds$random), y = ds$random,
                              type = "scatter",
                              mode = "lines",
                              fill="tonexty",
                              line = list(color = "rgb(68, 1, 84)"),
                              fillcolor="rgba(68, 1, 84, 0.5)",
                              name = "Random")

f2 = subplot(p1, p2, p3, p4, nrows=4) %>%
  layout(title='<b> Time Series Decomposition <b>')
f2;
```

# Resultados e interpretación

## Identificación

### Transformación de la serie

#### Varianza constante

```{r}
m <- apply(matrix(ser, nrow=12), 2, mean)
v <- apply(matrix(ser, nrow=12), 2, var)

f3 = plot_ly(x=~m, y=~v,
        marker = list(size = 7,
                      color = '#2a788e',
                      line = list(color = '#414487',width = 1))
        ) %>%
  layout(title='<b> Variance~Mean <b>',
         xaxis=list(title='Mean'),
         yaxis=list(title='Variance'))
f3;
```


```{r}
f4 = plot_ly(x=~floor(time(ser)), y=~ser, type='box',
        boxpoints = 'suspectedoutliers',
        fillcolor="#2a788e",
        line=list(color="#414487")
        ) %>%
  layout(title='<b> Box Plot for periods <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='Time Series'))
f4
```

$$\frac{X_t^{\lambda}-1}{\lambda}, \ \ \lambda \in [-1,2], \ \lambda \neq 0$$

```{r}
lambda = BoxCox.lambda(ser, method = c("guerrero", "loglik"), lower = -1, upper = 2)
bcser = (ser^lambda-1)/lambda
```

```{r}
m <- apply(matrix(bcser, nrow=12), 2, mean)
v <- apply(matrix(bcser, nrow=12), 2, var)

f5 = plot_ly(x=~m, y=~v,
        marker = list(size = 7,
                      color = '#2a788e',
                      line = list(color = '#414487',width = 1))
        ) %>%
  layout(title='<b> Variance~Mean <b>',
         xaxis=list(title='Mean'),
         yaxis=list(title='Variance'))
f5
```

```{r}
f6 = plot_ly(x=~floor(time(bcser)), y=~bcser, type='box',
        boxpoints = 'suspectedoutliers',
        fillcolor="#2a788e",
        line=list(color="#414487")
        ) %>%
  layout(title='<b> Box Plot for periods <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='Time Series'))
f6
```

```{r}
f7 = plot_ly(x=~time(bcser), y=~bcser,
        type = "scatter",
        fill="tozeroy",
        mode="lines",
        line = list(color = "#2a788e"),
        fillcolor="rgba(42, 120, 142, 0.5)"
        ) %>% 
  layout(title='<b> Time series after Box-Cox transformation <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='(Thousand million euros)')
         )
f7
```


#### Patrón estacional


```{r}
f8 = ts_seasonal(bcser, type="all", title=" <b> Seasonality plot for Time Series <b>")

monthplot(bcser)

f8
```


$$(1-B^{12})X_t$$

```{r}
d12bcser = diff(bcser,12)
f9 = plot_ly() %>%
  add_trace(x=~time(d12bcser), y=~d12bcser,
            type = "scatter",
            fill="tonexty",
            mode="lines",
            line = list(color = "#2a788e"),
            fillcolor="rgba(42, 120, 142, 0.5)",
            name='Time Series'
            ) %>%
  add_trace(x=~time(d12bcser), y=~mean(d12bcser),
            type = "scatter",
            mode="lines",
            name='Mean',
            line=list(color='#rgb(68, 1, 84)', dash='dash')
            ) %>%
  layout(title='<b> Time Series after seasonal differentation <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='(Thousand million euros)')) 
f9
```

```{r}
monthplot(d12bcser)
```

```{r}
f10 = ts_seasonal(d12bcser, type="all", title=" <b> Seasonality plot for Time Series <b>")
f10
```


#### Media constante


```{r}
var(d12bcser)
var(diff(d12bcser))
var(diff(diff(d12bcser)))
```


```{r}
d1d12bcser = diff(d12bcser)
```

### Serie estacionaria

$$W_t = (1-B)(1-B^{12})\frac{X_t^\lambda-1}{\lambda} \ \ , \ \lambda≃0.395$$

```{r}
f11 = plot_ly() %>%
  add_trace(x=~time(d1d12bcser), y=~d1d12bcser,
            type = "scatter",
            fill="tonexty",
            mode="lines",
            line = list(color = "#2a788e"),
            fillcolor="rgba(42, 120, 142, 0.5)",
            name='Time Series'
            ) %>%
  add_trace(x=~time(d12bcser), y=~mean(d12bcser),
            type = "scatter",
            mode="lines",
            name='Mean',
            line=list(color='#rgb(68, 1, 84)', dash='dash')
            ) %>%
  layout(title='<b> Stationary Time Series <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='(Thousand million euros)')) 
f11
```

### Modelos propuestos

```{r}
f12 = ts_cor(d1d12bcser, lag.max = 72)
f12
```

$$H_0: \rho(h) = 0 \\ H_1: \rho(h) \neq 0$$

$$\mbox{ARIMA}(2,1,0)(0,1,6)_{12}$$

```{r}
arima(d1d12bcser, order=c(2,0,0), seasonal=list(order=c(0,0,6), period=12))
```

$$\mbox{ARIMA}(2,1,1)(4,1,0)_{12}$$

```{r}
arima(d1d12bcser, order=c(2,0,1), seasonal=list(order=c(4,0,0), period=12))
```

$$\mbox{ARIMA}(2,1,0)(2,1,2)_{12}$$

```{r}
arima(d1d12bcser, order=c(2,0,0), seasonal=list(order=c(2,0,2), period=12))
```

$$\mbox{ARIMA}(2,1,1)(2,1,1)_{12}$$

```{r}
arima(d1d12bcser, order=c(2,0,1), seasonal=list(order=c(2,0,1), period=12))
```

### Estimación Modelo 1

El Modelo 1 $\mbox{ARIMA}(2,1,1)(4,1,0)_{12}$ es de la forma:

$$(1 - \phi_1 B - \phi_2 B^2)(1 - \Phi_1 B^{12} - \Phi_2 B^{24} - \Phi_3 B^{36} - \Phi_4 B^{48})(1-B)(1-B^{12})\frac{(X_t - \mu_1)^\lambda-1}{\lambda} = (1+ \theta_1 B)Z_t$$

```{r}
m1 = arima(d1d12bcser, order=c(2,0,1), seasonal=list(order=c(4,0,0), period=12))
m1
```

```{r}
cat("Is the mean significant?",abs(m1$coef[8]/sqrt(diag(m1$var.coef)[8])) > 2)
```

```{r}
m1 = arima(bcser, order=c(2,1,1), seasonal=list(order=c(4,1,0), period=12))
m1
```

```{r}
cat("\nT-ratios:",round(m1$coef/sqrt(diag(m1$var.coef)),2))
```

```{r}
arima(bcser, order=c(2,1,1), seasonal=list(order=c(4,1,0), period=12),
           fixed=c(NA,NA,0,NA,NA,NA,NA))
```

El resto de parámetros si son significativos, como se ha visto anteriormente, con lo que el modelo estimado $\mbox{ARIMA}(2,1,1)(4,1,0)_{12}$ resultante es:

$$(1 + 0.7602 B + 0.3825 B^2)(1 + 0.5954 B^{12} + 0.6411 B^{24} + 0.4560 B^{36} + 0.4251 B^{48})(1-B)(1-B^{12})\frac{(X_t - \mu_1)^\lambda-1}{\lambda} = (1 + 0.2315 B)Z_t$$

### Estimación Modelo 2

El Modelo 2 $\mbox{ARIMA}(2,1,0)(2,1,2)_{12}$ es de la forma:

$$(1 - \phi_1 B - \phi_2 B^2)(1 - \Phi_1 B^{12} - \Phi_2 B^{24})(1-B)(1-B^{12})\frac{(X_t - \mu_2)^\lambda-1}{\lambda} = (1+ \Theta_1 B^{12} + \Theta_2 B^{24})Z_t$$

```{r}
m2 = arima(d1d12bcser, order=c(2,0,0), seasonal=list(order=c(2,0,2), period=12))
m2
```

```{r}
cat("Is the mean significant?",abs(m2$coef[7]/sqrt(diag(m2$var.coef)[7])) > 2)
```

```{r}
m2 = arima(bcser, order=c(2,1,0), seasonal=list(order=c(2,1,2), period=12))
m2
```

```{r}
cat("\nT-ratios:",round(m2$coef/sqrt(diag(m2$var.coef)),2))
```

## Validación

### Varianza constante de residuos

#### Modelo 1

```{r}
resi1 <- resid(m1)
resi1 <- window(resi1, start=c(2000,2))
```

```{r}
p1 = plot_ly() %>%
  add_trace(x=~time(d1d12bcser), y=~resi1,
            type = "scatter",
            fill="tonexty",
            line = list(color = "#2a788e"),
            fillcolor="rgba(42, 120, 142, 0.5)",
            mode="lines",
            name='Residuals of model 1'
            ) %>%
  add_lines(x=~time(d1d12bcser), y=~-3*sd(resi1),
            fill=F,
            line=list(color='#440154',dash='dot'),
            name='Lower IC limit'
            ) %>%
  add_lines(x=~time(d1d12bcser), y=~3*sd(resi1),
            fill=F,
            line=list(color='#440154', dash='dot'),
            name="Upper IC limit"
            ) %>%
  layout(title='<b> Residuals of model 1 <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='(Thousand million euros)'))

p2 = ggplotly(ggplot(data=NULL, aes(x=time(d1d12bcser), y=abs(resi1))) +
  geom_smooth(fill="#2a788e") + 
  geom_point(color="#440154", fill='#414487', shape=21) +
  theme_bw() + 
  xlab("Time") + ylab("abs(residuals 1)") +
  ggtitle(" <b> Absolute value of model 1 residuals <b>") +
  theme(plot.title = element_text(hjust = 0.5)))

f13 = subplot(p1, p2, nrows=2, shareX = T) %>%
  layout(title='<b> Constant Variance plots <b>')
f13

scatter.smooth(sqrt(abs(resi1)), lpars = list(col=2))
```

#### Modelo 2

```{r}
resi2 <- resid(m2)
resi2 <- window(resi2, start=c(2000,2))
```

```{r}
p1 = plot_ly() %>%
  add_trace(x=~time(d1d12bcser), y=~resi2,
            type = "scatter",
            fill="tonexty",
            line = list(color = "#2a788e"),
            fillcolor="rgba(42, 120, 142, 0.5)",
            mode="lines",
            name='Residuals of model 2'
            ) %>%
  add_lines(x=~time(d1d12bcser), y=~-3*sd(resi2),
            fill=F,
            line=list(color='#440154',dash='dot'),
            name='Lower IC limit'
            ) %>%
  add_lines(x=~time(d1d12bcser), y=~3*sd(resi2),
            fill=F,
            line=list(color='#440154', dash='dot'),
            name="Upper IC limit"
            ) %>%
  layout(title='<b> Residuals of model 2 <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='(Thousand million euros)'))

p2 = ggplotly(ggplot(data=NULL, aes(x=time(d1d12bcser), y=abs(resi2))) +
  geom_smooth(fill="#2a788e") + 
  geom_point(color="#440154", fill='#414487', shape=21) +
  theme_bw() + 
  xlab("Time") + ylab("abs(residuals 2)") +
  ggtitle(" <b> Absolute value of model 2 residuals <b>") +
  theme(plot.title = element_text(hjust = 0.5)))

f14 = subplot(p1, p2, nrows=2, shareX = T) %>%
  layout(title='<b> Constant Variance plots <b>')
f14
```

### Hipótesis de normalidad de residuos

#### Modelo 1

```{r}
f15 = ggplot(data=NULL, aes(sample=resi1)) +
  stat_qq_band(color='#1F968BFF', fill='#1F968BFF', alpha=0.3) +
  stat_qq_line(color='#39568CFF') +
  stat_qq_point(color="#440154FF", fill='#3b528b', shape=21) +
  theme_bw() +
  xlab("Theoretical Quantiles") + ylab("Sample Quantiles") +
  ggtitle("Normal Q-Q Plot") +
  theme(plot.title = element_text(hjust = 0.5))
f15
```

```{r}
hist(resi1,breaks=20, freq=FALSE)
d <- curve(dnorm(x, mean=mean(resi1), sd=sd(resi1)), col=2, add=T)

f16 = plot_ly() %>%
  add_histogram(x=~resi1,
        name="Model 1 residuals",
        marker = list(color = "#22a884",
                      line = list(color = "#2a788e", width = 2))
        ) %>%
  add_trace(x=~d$x, y=~d$y,
            type = 'scatter',
            mode = 'none',
            name = "Density curve",
            fill = "tozeroy",
            fillcolor="rgba(168, 216, 234, 0.5)",
            yaxis = "y2"
            ) %>% 
  layout(yaxis2 = list(overlaying = "y", side = "right", title = "",
                       zeroline = FALSE,
                       showline = FALSE,
                       showticklabels = FALSE,
                       showgrid = FALSE),
         title='<b> Histogram of model 1 residuals <b>',
         xaxis=list(title='Residuals'),
         yaxis=list(title='Density')
         )
f16
```

```{r}
shapiro.test(resi1)
```

#### Modelo 2

```{r}
f17 = ggplot(data=NULL, aes(sample=resi2)) +
  stat_qq_band(color='#1F968BFF', fill='#1F968BFF', alpha=0.3) +
  stat_qq_line(color='#39568CFF') +
  stat_qq_point(color="#440154FF", fill='#3b528b', shape=21) +
  theme_bw() +
  xlab("Theoretical Quantiles") + ylab("Sample Quantiles") +
  ggtitle("Normal Q-Q Plot") +
  theme(plot.title = element_text(hjust = 0.5))
f17
```

```{r}
hist(resi2,breaks=20, freq=FALSE)
d <- curve(dnorm(x, mean=mean(resi2), sd=sd(resi2)), col=2, add=T)

f18 = plot_ly() %>%
  add_histogram(x=~resi2,
        name="Model 1 residuals",
        marker = list(color = "#22a884",
                      line = list(color = "#2a788e", width = 2))
        ) %>%
  add_trace(x=~d$x, y=~d$y,
            type = 'scatter',
            mode = 'none',
            name = "Density curve",
            fill = "tozeroy",
            fillcolor="rgba(168, 216, 234, 0.5)",
            yaxis = "y2"
            ) %>% 
  layout(yaxis2 = list(overlaying = "y", side = "right", title = "",
                       zeroline = FALSE,
                       showline = FALSE,
                       showticklabels = FALSE,
                       showgrid = FALSE),
         title='<b> Histogram of model 2 residuals <b>',
         xaxis=list(title='Residuals'),
         yaxis=list(title='Density')
         )
f18


```

```{r}
shapiro.test(resi2)
```

### Independencia de residuos

#### Modelo 1

```{r}
resi1 <- resid(m1)
f19 = ts_cor(resi1, lag.max = 72)
f19
```

```{r}
tsdiag(m1,gof.lag=72)
```

#### Modelo 2

```{r}
f20 = ts_cor(resi2, lag.max = 72)
f20
```

```{r}
tsdiag(m2,gof.lag=72)
```

## Propiedad de causalidad y/o invertibilidad

### Modelo 1

```{r}
Mod(polyroot(c(1,-m1$model$phi)))
```

```{r}
Mod(polyroot(c(1,m1$model$theta)))
```

```{r}
f21 = ggplotly(autoplot(m1) +
  geom_point(color="#440154", fill='#414487', shape=21, size=1) +
  theme_bw() +
  ggtitle(" <b> Invers roots model 1 <b>") +
  theme(plot.title = element_text(hjust = 0.5)))
f21
```

### Modelo 2

```{r}
Mod(polyroot(c(1,-m2$model$phi)))
```

```{r}
Mod(polyroot(c(1,m2$model$theta)))
```

```{r}
f22 = ggplotly(autoplot(m2) +
  geom_point(color="#440154", fill='#414487', shape=21, size=1) +
  theme_bw() +
  ggtitle(" <b> Invers roots model 1 <b>") +
  theme(plot.title = element_text(hjust = 0.5)))
f22
```

## Estabilidad

```{r}
last=c(2017,12); train=window(ser, end=last)
```

### Modelo 1

```{r}
bctrain = (train^lambda-1)/lambda

m1_train <- arima(bctrain, order=c(2,1,1),
                  seasonal=list(order=c(4,1,0), period=12))
m1_train
m1
```

```{r}
cat("\nT-ratios:",round(m1_train$coef/sqrt(diag(m1_train$var.coef)),2))
cat("\nT-ratios:",round(m1$coef/sqrt(diag(m1$var.coef)),2))
```

### Modelo 2

```{r}
m2_train <- arima(bctrain, order=c(2,1,0),
                  seasonal=list(order=c(2,1,2), period=12))
m2_train
m2
```

```{r}
cat("\nT-ratios:",round(m2_train$coef/sqrt(diag(m2_train$var.coef)),2))
cat("\nT-ratios:",round(m2$coef/sqrt(diag(m2$var.coef)),2))
```

## Predicciones

#### Modelo 1

```{r}
pre1 = predict(m1_train, n.ahead=12)

pr1 = (lambda*(pre1$pred)+1)^(1/lambda)

tl1 = pre1$pred - qnorm(1-0.05/2,mean = 0,sd = 1,lower.tail = TRUE)*pre1$se
tl1 = (lambda*(tl1)+1)^(1/lambda)

tu1 = pre1$pred + qnorm(1-0.05/2,mean = 0,sd = 1,lower.tail = TRUE)*pre1$se
tu1 = (lambda*(tu1)+1)^(1/lambda)
```

```{r}
f23 = plot_ly(x=~time(ser), y=~ser,
        type = "scatter",
        mode = "lines+markers",
        line = list(color="#2a788e"),
        marker = list(color="#2a788e"),
        name = "Observed"
        ) %>%
  add_trace(x = window(time(ser), start=c(2018,1)),
            y = pr1,
            line = list(color="rgb(68, 1, 84)", dash = "dash"),
            marker = list(color="rgb(68, 1, 84)"),
            name = "Predicted"
            )%>%
  add_ribbons(x = window(time(ser), start=c(2018,1)),
              ymin=tl1, ymax=tu1,
              line = list(color = 'rgba(34, 168, 132, 0.2)'),
              fillcolor = 'rgba(34, 168, 132, 0.2)',
              name = "95% confidence",
              inherit = FALSE
              ) %>%
  layout(title='<b> Prediction for the test set using model 1 <b>',
         xaxis=list(title='Time', range=c(2016,2019)),
         yaxis=list(title='(Thousand million euros)')
         )
f23
```

#### Modelo 2

```{r}
pre2 = predict(m2_train, n.ahead=12)


pr2 = (lambda*(pre2$pred)+1)^(1/lambda)

tl2 = pre2$pred - qnorm(1-0.05/2,mean = 0,sd = 1,lower.tail = TRUE)*pre2$se
tl2 = (lambda*(tl2)+1)^(1/lambda)

tu2 = pre2$pred + qnorm(1-0.05/2,mean = 0,sd = 1,lower.tail = TRUE)*pre2$se
tu2 = (lambda*(tu2)+1)^(1/lambda)
```

```{r}
f24 = plot_ly(x=~time(ser), y=~ser,
        type = "scatter",
        mode = "lines+markers",
        line = list(color="#2a788e"),
        marker = list(color="#2a788e"),
        name = "Observed"
        ) %>%
  add_trace(x = window(time(ser), start=c(2018,1)),
            y = pr2,
            line = list(color="rgb(68, 1, 84)", dash = "dash"),
            marker = list(color="rgb(68, 1, 84)"),
            name = "Predicted"
            ) %>%
  add_ribbons(x = window(time(ser), start=c(2018,1)),
              ymin=tl2, ymax=tu2,
              line = list(color = 'rgba(34, 168, 132, 0.2)'),
              fillcolor = 'rgba(34, 168, 132, 0.2)',
              name = "95% confidence",
              inherit = FALSE
              ) %>%
  layout(title='<b> Prediction for the test set using model 2 <b>',
         xaxis=list(title='Time', range=c(2016,2019)),
         yaxis=list(title='(Thousand million euros)')
         )
f24
```

## Selección

### Medidas de capacidad de predicción

```{r}
start=c(2017,12); last=c(2018,12);
obs = window(ser, start = start, end = last)
```

#### Modelo 1

```{r}
cat("RMSPE1: ", sqrt(mean(((obs-pr1)/obs)^2)), "\n")
cat("MAPE1: ", mean(abs(obs-pr1)/obs))
```

#### Modelo 2

```{r}
cat("RMSPE2: ", sqrt(mean(((obs-pr2)/obs)^2)), "\n")
cat("MAPE2: ", mean(abs(obs-pr2)/obs))
```

### Intervalos de confianza

#### Modelo 1

```{r}
cat("Mean length of IC for model 1: ",mean(tu1-tl1))

```

#### Modelo 2

```{r}
cat("Mean length of IC for model 2: ",mean(tu2-tl2))
```

### Medidas de adecuación a los datos

```{r}
cat("AIC Modelo 1: ", AIC(m1), "\n")
cat("AIC Modelo 2: ", AIC(m2), "\n")
cat("BIC Modelo 1: ", BIC(m1), "\n")
cat("BIC Modelo 2: ", BIC(m2), "\n")
```

## Tratamiento de efectos de calendario

```{r}
source("Practicas/calendarEffects.r")
```

```{r}
length(ser)
```

```{r}
start = c(1999,1,length(ser))
vEa = Weaster(start)
# vEa
```

```{r}
vTD = Wtrad(start)
# vTD
```

```{r}
m1
```

```{r}
m1Ea = arima(bcser, order=c(2,1,1),
             seasonal=list(order=c(4,1,0), period=12),
             xreg = data.frame(vEa))
m1Ea
```

```{r}
m1TD = arima(bcser, order=c(2,1,1),
             seasonal=list(order=c(4,1,0), period=12),
             xreg = data.frame(vTD))
m1TD
```

```{r}
m1EC = arima(bcser, order=c(2,1,1),
             seasonal=list(order=c(4,1,0), period=12),
             xreg = data.frame(vEa,vTD))
m1EC
```


```{r}
# coef(m1EC)["vEa"]*vEa
```


```{r}
# coef(m1EC)["vTD"]*vTD
```

...

```{r}
bcserEC = bcser - coef(m1EC)["vEa"]*vEa - coef(m1EC)["vTD"]*vTD
serEC = (lambda*(bcserEC)+1)^(1/lambda)
```


## Re-identificación modelo

```{r}
m <- apply(matrix(bcserEC, nrow=12), 2, mean)
v <- apply(matrix(bcserEC, nrow=12), 2, var)

f25 = plot_ly(x=~m, y=~v,
        marker = list(size = 7,
                      color = '#2a788e',
                      line = list(color = '#414487',width = 1))
        ) %>%
  layout(title='<b> Variance~Mean <b>',
         xaxis=list(title='Mean'),
         yaxis=list(title='Variance'))
f25
```


```{r}
f26 = ts_seasonal(bcserEC, type="all", title=" <b> Seasonality plot for Time Series <b>")
f26
```

```{r}
d12bcserEC = diff(bcserEC, 12)
```

```{r}
f27 = plot_ly() %>%
  add_trace(x=~time(d12bcserEC), y=~d12bcserEC,
            type = "scatter",
            fill="tonexty",
            mode="lines",
            line = list(color = "#2a788e"),
            fillcolor="rgba(42, 120, 142, 0.5)",
            name='Time Series'
            ) %>%
  add_trace(x=~time(d12bcserEC), y=~mean(d12bcserEC),
            type = "scatter",
            mode="lines",
            name='Mean',
            line=list(color='#rgb(68, 1, 84)', dash='dash')
            ) %>%
  layout(title='<b> Time Series <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='(Thousand million euros)')) 
f27
```


```{r}
var(d12bcserEC)[1]
var(diff(d12bcserEC))[1]
var(diff(diff(d12bcserEC)))[1]
```

```{r}
d1d12bcserEC = diff(d12bcserEC)
```

```{r}
f28 = plot_ly() %>%
  add_trace(x=~time(d1d12bcserEC), y=~d1d12bcserEC,
            type = "scatter",
            fill="tonexty",
            mode="lines",
            line = list(color = "#2a788e"),
            fillcolor="rgba(42, 120, 142, 0.5)",
            name='Time Series'
            ) %>%
  add_trace(x=~time(d1d12bcserEC), y=~mean(d1d12bcserEC),
            type = "scatter",
            mode="lines",
            name='Mean',
            line=list(color='#rgb(68, 1, 84)', dash='dash')
            ) %>%
  layout(title='<b> Stationary Time Series <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='(Thousand million euros)')) 
f28
```


```{r}
var(d1d12bcser)
var(d1d12bcserEC)
```



```{r}
f29 = ts_cor(d1d12bcserEC, lag.max = 72)
f29
```

```{r}
vEa2 = window(vEa,end=c(2017,11))
vTD2 = window(vTD,end=c(2017,11))

arima(bcser,order=c(0,1,1),
      seasonal=list(order=c(0,1,1),period=12),
      xreg=data.frame(vEa,vTD))
```


```{r}
mEC = arima(bcser,order=c(2,1,0),
           seasonal=list(order=c(0,1,1),period=12),
      xreg=data.frame(vEa,vTD))
mEC
```

## Estimación modelo con efectos de calendario

```{r}
cat("\nT-ratios:",round(mEC$coef/sqrt(diag(mEC$var.coef)),2))
```

## Validación

### Varianza constante de residuos

```{r}
resiEC <- resid(mEC)
resiEC <- window(resiEC, start=c(2000,2))
```

```{r}
p1 = plot_ly() %>%
  add_trace(x=~time(d1d12bcser), y=~resiEC,
            type = "scatter",
            fill="tonexty",
            line = list(color = "#2a788e"),
            fillcolor="rgba(42, 120, 142, 0.5)",
            mode="lines",
            name='Residuals of model 1'
            ) %>%
  add_lines(x=~time(d1d12bcser), y=~-3*sd(resiEC),
            fill=F,
            line=list(color='#440154',dash='dot'),
            name='Lower IC limit'
            ) %>%
  add_lines(x=~time(d1d12bcser), y=~3*sd(resiEC),
            fill=F,
            line=list(color='#440154', dash='dot'),
            name="Upper IC limit"
            ) %>%
  layout(title='<b> Residuals of model 1 <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='(Thousand million euros)'))

p2 = ggplotly(ggplot(data=NULL, aes(x=time(d1d12bcserEC), y=abs(resiEC))) +
  geom_smooth(fill="#2a788e") + 
  geom_point(color="#440154", fill='#414487', shape=21) +
  theme_bw() + 
  xlab("Time") + ylab("abs(residuals 1)") +
  ggtitle(" <b> Absolute value of model residuals <b>") +
  theme(plot.title = element_text(hjust = 0.5)))

f30 = subplot(p1, p2, nrows=2, shareX = T) %>%
  layout(title='<b> Constant Variance plots <b>')
f30
```

### Hipótesis de normalidad de residuos

```{r}
f31 = ggplot(data=NULL, aes(sample=resiEC)) +
  stat_qq_band(color='#1F968BFF', fill='#1F968BFF', alpha=0.3) +
  stat_qq_line(color='#39568CFF') +
  stat_qq_point(color="#440154FF", fill='#3b528b', shape=21) +
  theme_bw() +
  xlab("Theoretical Quantiles") + ylab("Sample Quantiles") +
  ggtitle("Normal Q-Q Plot") +
  theme(plot.title = element_text(hjust = 0.5))
f31
```

```{r}
f32 = plot_ly() %>%
  add_histogram(x=~resiEC,
        name="Model 1 residuals",
        marker = list(color = "#22a884",
                      line = list(color = "#2a788e", width = 2))
        ) %>%
  add_trace(x=~d$x, y=~d$y,
            type = 'scatter',
            mode = 'none',
            name = "Density curve",
            fill = "tozeroy",
            fillcolor="rgba(168, 216, 234, 0.5)",
            yaxis = "y2"
            ) %>% 
  layout(yaxis2 = list(overlaying = "y", side = "right", title = "",
                       zeroline = FALSE,
                       showline = FALSE,
                       showticklabels = FALSE,
                       showgrid = FALSE),
         title='<b> Histogram of model residuals <b>',
         xaxis=list(title='Residuals'),
         yaxis=list(title='Density')
         )
f32
```

```{r}
shapiro.test(resiEC)
```

### Independencia de residuos

```{r}
resiEC <- resid(mEC)
f33 = ts_cor(resiEC, lag.max = 72)
f33
```

```{r}
tsdiag(mEC,gof.lag=72)
```

## Propiedad de causalidad y/o invertibilidad

```{r}
Mod(polyroot(c(1,-mEC$model$phi)))
```

```{r}
Mod(polyroot(c(1,mEC$model$theta)))
```

```{r}
f34 = ggplotly(autoplot(mEC) +
  geom_point(color="#440154", fill='#414487', shape=21, size=1) +
  theme_bw() +
  ggtitle(" <b> Invers roots model <b>") +
  theme(plot.title = element_text(hjust = 0.5)))
f34
```

## Estabilidad

```{r}
last=c(2017,12); trainEC=window(ser, end=last)
vEa2=window(vEa,end=last)
vTD2=window(vTD,end=last)
```

```{r}
bctrainEC = (trainEC^lambda-1)/lambda
mEC_train <- arima(bctrainEC, order=c(2,1,0),
                  seasonal=list(order=c(0,1,1), period=12),
                  xreg=data.frame(vEa2,vTD2))
mEC_train
mEC
```

```{r}
cat("\nT-ratios:",round(mEC_train$coef/sqrt(diag(mEC_train$var.coef)),2))
cat("\nT-ratios:",round(mEC$coef/sqrt(diag(mEC$var.coef)),2))
```

## Predicciones

```{r}

vEa2=window(vEa,start=last+c(0,1))
vTD2=window(vTD,start=last+c(0,1))
preEC = predict(mEC_train, n.ahead=12,newxreg=data.frame(vEa2,vTD2))

pr1 = (lambda*(preEC$pred)+1)^(1/lambda)

tl1 = preEC$pred - qnorm(1-0.05/2,mean = 0,sd = 1,lower.tail = TRUE)*preEC$se
tl1 = (lambda*(tl1)+1)^(1/lambda)

tu1 = preEC$pred + qnorm(1-0.05/2,mean = 0,sd = 1,lower.tail = TRUE)*preEC$se
tu1 = (lambda*(tu1)+1)^(1/lambda)
```

```{r}
f35 = plot_ly(x=~time(ser), y=~ser,
        type = "scatter",
        mode = "lines+markers",
        line = list(color="#2a788e"),
        marker = list(color="#2a788e"),
        name = "Observed"
        ) %>%
  add_trace(x = window(time(ser), start=c(2018,1)),
            y = pr1,
            line = list(color="rgb(68, 1, 84)", dash = "dash"),
            marker = list(color="rgb(68, 1, 84)"),
            name = "Predicted"
            )%>%
  add_ribbons(x = window(time(ser), start=c(2018,1)),
              ymin=tl1, ymax=tu1,
              line = list(color = 'rgba(34, 168, 132, 0.2)'),
              fillcolor = 'rgba(34, 168, 132, 0.2)',
              name = "95% confidence",
              inherit = FALSE
              ) %>%
  layout(title='<b> Prediction for the test set using modelEC <b>',
         xaxis=list(title='Time', range=c(2016,2019)),
         yaxis=list(title='(Thousand million euros)')
         )
f35
```


## Selección

### Medidas de capacidad de predicción

```{r}
start=c(2017,12); last=c(2018,12);
obs = window(ser, start = start, end = last)
```


```{r}
cat("RMSPE: ", sqrt(mean(((obs-pr1)/obs)^2)), "\n")
cat("MAPE: ", mean(abs(obs-pr1)/obs))
```

### Intervalos de confianza

```{r}
cat("Mean length of IC for model: ",mean(tu1-tl1))
```


### Medidas de adecuación a los datos

```{r}
cat("AIC Modelo: ", AIC(mEC), "\n")
cat("BIC Modelo: ", BIC(mEC), "\n")
```


## Tratamiento de atípicos

```{r}
source("Practicas/atipics2.r")

mod = mEC

mod.atip=outdetec(mod,dif=c(1,12),crit=3,LS=T)

atipics=mod.atip$atip[order(mod.atip$atip[,1]),]
meses=c("Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic")
data.frame(atipics,
           Fecha=paste(meses[(atipics[,1]-1)%%12+1],
                       start(bcserEC)[1]+((atipics[,1]-1)%/%12)),
           PercVar=exp(atipics[,3])*100)
```

```{r}
bcser.lin=lineal(bcser,mod.atip$atip)

ser.lin = (lambda*(bcser.lin)+1)^(1/lambda)

f36 = plot_ly(x = time(ser), y = ser,
             type = "scatter",
             mode="lines",
             fill="tonexty",
             line = list(color = "#2a788e"),
             fillcolor="rgba(42, 120, 142, 0.5)",
             name = "ser"
             ) %>% 
  add_trace(x=~time(ser.lin), y=~ser.lin,
            type = "scatter",
            name = "ser.lin",
            mode="lines",
            fill=F,
            line = list(color = "rgb(65, 68, 135)")
             ) %>%
  layout(title='<b> Total exportations in Spain <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='(Thousand million euros)')
         ) 
f36
```

```{r}
f36 = plot_ly(x = time(bcser), y = bcser-bcser.lin,
             type = "scatter",
             mode="lines",
             line = list(color = "#2a788e"),
             name = "ser"
             ) %>%
  layout(title='<b> Total exportations in Spain <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='(Thousand million euros)')
         ) 
f36
```

```{r}
bcserEC.lin = bcser.lin - coef(mEC)["vEa"]*vEa - coef(mEC)["vTD"]*vTD
```



## Re-identificación modelo

```{r}
m <- apply(matrix(bcserEC.lin, nrow=12), 2, mean)
v <- apply(matrix(bcserEC.lin, nrow=12), 2, var)

f37 = plot_ly(x=~m, y=~v,
        marker = list(size = 7,
                      color = '#2a788e',
                      line = list(color = '#414487',width = 1))
        ) %>%
  layout(title='<b> Variance~Mean <b>',
         xaxis=list(title='Mean'),
         yaxis=list(title='Variance'))
f37
```


```{r}
f38 = ts_seasonal(bcserEC.lin, type="all", title=" <b> Seasonality plot for Time Series <b>")
f38
```

```{r}
d12bcserEC.lin = diff(bcserEC.lin, 12)
```

```{r}
f39 = plot_ly() %>%
  add_trace(x=~time(d12bcserEC.lin), y=~d12bcserEC.lin,
            type = "scatter",
            fill="tonexty",
            mode="lines",
            line = list(color = "#2a788e"),
            fillcolor="rgba(42, 120, 142, 0.5)",
            name='Time Series'
            ) %>%
  add_trace(x=~time(d12bcserEC.lin), y=~mean(d12bcserEC.lin),
            type = "scatter",
            mode="lines",
            name='Mean',
            line=list(color='#rgb(68, 1, 84)', dash='dash')
            ) %>%
  layout(title='<b> Time Series <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='(Thousand million euros)')) 
f39
```


```{r}
var(d12bcserEC.lin)[1]
var(diff(d12bcserEC.lin))[1]
var(diff(diff(d12bcserEC.lin)))[1]
```

```{r}
d1d12bcserEC.lin = diff(d12bcserEC.lin)
```

```{r}
f40 = plot_ly() %>%
  add_trace(x=~time(d1d12bcserEC.lin), y=~d1d12bcserEC.lin,
            type = "scatter",
            fill="tonexty",
            mode="lines",
            line = list(color = "#2a788e"),
            fillcolor="rgba(42, 120, 142, 0.5)",
            name='Time Series'
            ) %>%
  add_trace(x=~time(d1d12bcserEC.lin), y=~mean(d1d12bcserEC.lin),
            type = "scatter",
            mode="lines",
            name='Mean',
            line=list(color='#rgb(68, 1, 84)', dash='dash')
            ) %>%
  layout(title='<b> Stationary Time Series <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='(Thousand million euros)')) 
f40
```


```{r}
var(d1d12bcser)
var(d1d12bcserEC)[1]
var(d1d12bcserEC.lin)[1]
```


```{r}
f41 = ts_cor(d1d12bcserEC.lin, lag.max = 72)
f41
```

```{r}
mOEC = arima(bcser.lin,order=c(2,1,0),
           seasonal=list(order=c(0,1,1),period=12),
           xreg=data.frame(vEa,vTD))
mOEC
```


```{r}
mOEC1 = arima(bcser.lin,order=c(0,1,1),
           seasonal=list(order=c(0,1,1),period=12),
           xreg=data.frame(vEa,vTD))
mOEC1
```


## Estimación modelo con efectos de calendario

```{r}
cat("\nT-ratios:",round(mOEC$coef/sqrt(diag(mOEC$var.coef)),2))
```

## Validación

### Varianza constante de residuos

```{r}
resiEC.lin <- resid(mOEC1)
resiEC.lin <- window(resiEC.lin, start=c(2000,2))
```

```{r}
p1 = plot_ly() %>%
  add_trace(x=~time(d1d12bcserEC.lin), y=~resiEC.lin,
            type = "scatter",
            fill="tonexty",
            line = list(color = "#2a788e"),
            fillcolor="rgba(42, 120, 142, 0.5)",
            mode="lines",
            name='Residuals of model'
            ) %>%
  add_lines(x=~time(d1d12bcserEC.lin), y=~-3*sd(resiEC.lin),
            fill=F,
            line=list(color='#440154',dash='dot'),
            name='Lower IC limit'
            ) %>%
  add_lines(x=~time(d1d12bcserEC.lin), y=~3*sd(resiEC.lin),
            fill=F,
            line=list(color='#440154', dash='dot'),
            name="Upper IC limit"
            ) %>%
  layout(title='<b> Residuals of model <b>',
         xaxis=list(title='Time'),
         yaxis=list(title='(Thousand million euros)'))

p2 = ggplotly(ggplot(data=NULL, aes(x=time(d1d12bcserEC.lin), y=abs(resiEC.lin))) +
  geom_smooth(fill="#2a788e") + 
  geom_point(color="#440154", fill='#414487', shape=21) +
  theme_bw() + 
  xlab("Time") + ylab("abs(residuals 1)") +
  ggtitle(" <b> Absolute value of model 1 residuals <b>") +
  theme(plot.title = element_text(hjust = 0.5)))

f42 = subplot(p1, p2, nrows=2, shareX = T) %>%
  layout(title='<b> Constant Variance plots <b>')
f42
```

### Hipótesis de normalidad de residuos

```{r}
f43 = ggplot(data=NULL, aes(sample=resiEC.lin)) +
  stat_qq_band(color='#1F968BFF', fill='#1F968BFF', alpha=0.3) +
  stat_qq_line(color='#39568CFF') +
  stat_qq_point(color="#440154FF", fill='#3b528b', shape=21) +
  theme_bw() +
  xlab("Theoretical Quantiles") + ylab("Sample Quantiles") +
  ggtitle("Normal Q-Q Plot") +
  theme(plot.title = element_text(hjust = 0.5))
f43
```

...

```{r}
f44 = plot_ly() %>%
  add_histogram(x=~resiEC.lin,
        name="Model 1 residuals",
        marker = list(color = "#22a884",
                      line = list(color = "#2a788e", width = 2))
        ) %>%
  add_trace(x=~d$x, y=~d$y,
            type = 'scatter',
            mode = 'none',
            name = "Density curve",
            fill = "tozeroy",
            fillcolor="rgba(168, 216, 234, 0.5)",
            yaxis = "y2"
            ) %>% 
  layout(yaxis2 = list(overlaying = "y", side = "right", title = "",
                       zeroline = FALSE,
                       showline = FALSE,
                       showticklabels = FALSE,
                       showgrid = FALSE),
         title='<b> Histogram of model residuals <b>',
         xaxis=list(title='Residuals'),
         yaxis=list(title='Density')
         )
f44
```

```{r}
shapiro.test(resiEC.lin)
```

### Independencia de residuos

```{r}
resiEC.lin <- resid(mOEC1)
f45 = ts_cor(resiEC.lin, lag.max = 72)
f45
```

```{r}
tsdiag(mOEC1,gof.lag=72)
```

## Propiedad de causalidad y/o invertibilidad


```{r}
Mod(polyroot(c(1,-mOEC1$model$phi)))
```

```{r}
Mod(polyroot(c(1,mOEC1$model$theta)))
```

```{r}
f46 = ggplotly(autoplot(mOEC1) +
  geom_point(color="#440154", fill='#414487', shape=21, size=1) +
  theme_bw() +
  ggtitle(" <b> Invers roots model <b>") +
  theme(plot.title = element_text(hjust = 0.5)))
f46
```

## Estabilidad

```{r}
last=c(2017,12); trainEC.lin = window(ser.lin, end=last)
```

```{r}
vEa2=window(vEa,end=last)
vTD2=window(vTD,end=last)

bctrainEC.lin = (trainEC.lin^lambda-1)/lambda
mEC_train.lin <- arima(bctrainEC.lin, order=c(0,1,1),
                  seasonal=list(order=c(0,1,1), period=12),
                  xreg=data.frame(vEa2,vTD2))
mEC_train.lin
mOEC1
```

```{r}
cat("\nT-ratios:",round(mEC_train.lin$coef/sqrt(diag(mEC_train.lin$var.coef)),2))
cat("\nT-ratios:",round(mOEC1$coef/sqrt(diag(mOEC1$var.coef)),2))
```

## Predicciones

```{r}
vEa2=window(vEa,start=last+c(0,1))
vTD2=window(vTD,start=last+c(0,1))

wLS <- sum(mod.atip$atip[mod.atip$atip[, 2] == "LS", 3])

preEC.lin = predict(mEC_train.lin, n.ahead=12,
                    newxreg=data.frame(vEa2,vTD2))

pr1 = (lambda*(preEC.lin$pred+wLS)+1)^(1/lambda)

tl1 = preEC.lin$pred - qnorm(1-0.05/2,mean = 0,sd = 1,lower.tail = TRUE)*preEC.lin$se
tl1 = (lambda*(tl1+wLS)+1)^(1/lambda)

tu1 = preEC.lin$pred + qnorm(1-0.05/2,mean = 0,sd = 1,lower.tail = TRUE)*preEC.lin$se
tu1 = (lambda*(tu1+wLS)+1)^(1/lambda)
```

```{r}
f47 = plot_ly(x=~time(ser), y=~ser,
        type = "scatter",
        mode = "lines+markers",
        line = list(color="#2a788e"),
        marker = list(color="#2a788e"),
        name = "Observed"
        ) %>%
  add_trace(x = window(time(ser), start=c(2018,1)),
            y = pr1,
            line = list(color="rgb(68, 1, 84)", dash = "dash"),
            marker = list(color="rgb(68, 1, 84)"),
            name = "Predicted"
            )%>%
  add_ribbons(x = window(time(ser), start=c(2018,1)),
              ymin=tl1, ymax=tu1,
              line = list(color = 'rgba(34, 168, 132, 0.2)'),
              fillcolor = 'rgba(34, 168, 132, 0.2)',
              name = "95% confidence",
              inherit = FALSE
              ) %>%
  layout(title='<b> Prediction for the test set using modelEC.lin <b>',
         xaxis=list(title='Time', range=c(2016,2019)),
         yaxis=list(title='(Thousand million euros)')
         )
f47
```


## Selección

### Medidas de capacidad de predicción

```{r}
start=c(2017,12); last=c(2018,12);
obs = window(ser, start = start, end = last)
```


```{r}
cat("RMSPE: ", sqrt(mean(((obs-pr1)/obs)^2)), "\n")
cat("MAPE: ", mean(abs(obs-pr1)/obs))
```

### Intervalos de confianza


```{r}
cat("Mean length of IC for model: ",mean(tu1-tl1))
```


### Medidas de adecuación a los datos

```{r}
cat("AIC Modelo: ", AIC(mOEC1), "\n")
cat("BIC Modelo: ", BIC(mOEC1), "\n")
```

```{r}
# 
# f = list(f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13,f14,f15,f16,f17,f18,f19,f20,f21,f22,f23,f24,f25,f26,f27,f28,f29,f30,f31,f32,f33,f34,f35,f36,f37,f38,f39,f40,f41,f42,f43,f44,f45,f46,f47)
# n = length(f)
# for (i in 1:n) {
#   orca(f[[i]], paste0("./f",i,".png"))
#   cat(i)
# }
# 
# rm(f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13,f14,f15,f16,f17,f18,f19,f20,f21,f22,f23,f24,f25,f26,f27,f28,f29,f30,f31,f32,f33,f34,f35,f36,f37,f38,f39,f40,f41,f42,f43,f44,f45,f46,f47)
```